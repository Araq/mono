#!/usr/bin/env bash

# DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"

set -e

git checkout dev

rm -rf tmp/releases
mkdir -p tmp/releases

version="2.1.1"

# base ---------------------------------------------------------------------------------------------
cp -r base tmp/releases

cat >tmp/releases/base/base.nimble <<EOL
version     = "${version}"
author      = "Alex Craft https://github.com/al6x"
description = "Extensions for Nim std"
license     = "MIT"

srcDir = "."

requires "nim >= 1.6"
EOL

# ext ----------------------------------------------------------------------------------------------
mkdir tmp/releases/ext
cp -r ext tmp/releases/ext
mv tmp/releases/ext/ext/readme.md tmp/releases/ext

cat >tmp/releases/ext/ext.nimble <<EOL
version     = "${version}"
author      = "Alex Craft https://github.com/al6x"
description = "Extensions for Nim std"
license     = "MIT"

srcDir = "."

requires "nim >= 1.6"
requires "https://github.com/al6x/nim?subdir=releases/base@#releases"
EOL

# ftext --------------------------------------------------------------------------------------------
mkdir tmp/releases/ftext
cp -r ftext tmp/releases/ftext
mv tmp/releases/ftext/ftext/readme.md tmp/releases/ftext
mv tmp/releases/ftext/ftext/readme tmp/releases/ftext

cat >tmp/releases/ftext/ftext.nimble <<EOL
version     = "${version}"
author      = "Alex Craft https://github.com/al6x"
description = "Formal Text, Text as Data"
license     = "MIT"

srcDir = "."

requires "nim >= 1.6"
requires "https://github.com/al6x/nim?subdir=releases/base@#releases"
requires "https://github.com/al6x/nim?subdir=releases/ext@#releases"
EOL

# mono ---------------------------------------------------------------------------------------------
mkdir tmp/releases/mono
cp -r mono tmp/releases/mono
mv tmp/releases/mono/mono/readme.md tmp/releases/mono

cat >tmp/releases/mono/mono.nimble <<EOL
version     = "${version}"
author      = "Alex Craft https://github.com/al6x"
description = "Mono UI Web Framework"
license     = "MIT"

srcDir = "."

requires "nim >= 1.6"
requires "https://github.com/al6x/nim?subdir=releases/base@#releases"
requires "https://github.com/al6x/nim?subdir=releases/ext@#releases"
requires "https://github.com/al6x/nim?subdir=releases/ftext@#releases"
EOL

# Switching to releases branch ---------------------------------------------------------------------
git checkout releases
rm -rf releases
mv tmp/releases .
git add .
git commit -m "version $version"
git push
git checkout dev
echo "release done, switched back to dev"